name: Build dnscat2

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ruby-dev gcc make
        gem install bundler --user-install
        export PATH="$PATH:$(ruby -e 'puts Gem.user_dir')/bin"
        echo 'export PATH="$PATH:$(ruby -e "puts Gem.user_dir")/bin"' >> $GITHUB_ENV

    - name: Setup Server
      run: |
        echo "Current PATH: $PATH"
        export PATH="$PATH:$(ruby -e 'puts Gem.user_dir')/bin"
        echo "Updated PATH: $PATH"
        cd server
        $(ruby -e 'puts Gem.user_dir')/bin/bundle install --path vendor/bundle

    - name: Build Client
      run: |
        cd client
        make

    - name: Upload Linux Client Binary
      uses: actions/upload-artifact@v4
      with:
        name: dnscat2-client-linux
        path: client/dnscat

  build-windows:
    runs-on: windows-latest
  
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
  
    - name: Install Dependencies
      shell: pwsh
      run: |
        $tempPath = "C:\\Temp\\mingw.7z"
        $destPath = "C:\\MinGW"
        $sevenZipPath = "C:\\Program Files\\7-Zip\\7z.exe"
        
        Write-Host "Step 1: Starting MinGW setup..."
        
        # Этап 1: Скачивание архива
        Write-Host "Step 2: Downloading MinGW..."
        try {
            Invoke-WebRequest -Uri "https://github.com/niXman/mingw-builds-binaries/releases/download/13.2.0-rt_v11-rev0/x86_64-13.2.0-release-posix-seh-ucrt-rt_v11-rev0.7z" -OutFile $tempPath
            Write-Host "MinGW archive downloaded successfully to $tempPath"
        } catch {
            Write-Error "Failed to download MinGW archive! Error: $_"
            exit 1
        }
        
        # Проверка загрузки файла
        Write-Host "Step 3: Verifying downloaded archive..."
        if (-Not (Test-Path $tempPath)) {
            Write-Error "Downloaded file does not exist at $tempPath"
            exit 1
        }
        if ((Get-Item $tempPath).Length -eq 0) {
            Write-Error "Downloaded file is empty!"
            exit 1
        }
        Write-Host "Downloaded archive is valid."
        
        # Этап 2: Распаковка архива
        Write-Host "Step 4: Extracting MinGW..."
        try {
            if (Test-Path $sevenZipPath) {
                Write-Host "Using 7-Zip for extraction..."
                & "$sevenZipPath" x $tempPath -o$destPath -y
            } else {
                Write-Host "7-Zip not found, using Expand-Archive..."
                Expand-Archive -Path $tempPath -DestinationPath $destPath -Force
            }
            Write-Host "MinGW archive extracted successfully."
        } catch {
            Write-Error "Failed to extract MinGW archive! Error: $_"
            exit 1
        }
        
        # Этап 3: Проверка содержимого
        Write-Host "Step 5: Verifying extraction..."
        if (-Not (Test-Path "$destPath\\bin")) {
            Write-Host "Directory 'bin' not found! Checking archive structure..."
            
            # Выводим список файлов и папок для диагностики
            Get-ChildItem -Path $destPath -Recurse | ForEach-Object { Write-Host $_.FullName }
        
            # Ищем папку 'bin' внутри поддиректорий
            $binDir = Get-ChildItem -Path $destPath -Recurse -Directory | Where-Object { $_.Name -eq "bin" }
            if ($binDir) {
                Write-Host "Found 'bin' directory at: $($binDir.FullName). Moving files to root directory..."
                
                # Перемещаем содержимое в корень MinGW
                Get-ChildItem -Path $binDir.Parent.FullName | ForEach-Object {
                    Move-Item -Path $_.FullName -Destination $destPath -Force
                }
        
                # Удаляем остаточные папки
                Remove-Item -Path $binDir.Parent.FullName -Recurse -Force
            } else {
                Write-Error "MinGW extraction failed! Could not find 'bin' directory even in subdirectories."
                exit 1
            }
        }
        
        Write-Host "Extraction successful, 'bin' directory found."
        
        # Этап 4: Добавление в PATH
        Write-Host "Step 6: Adding MinGW to PATH..."
        $binPath = "$destPath\\bin"
        try {
            $env:PATH = "$binPath;" + $env:PATH
            [System.Environment]::SetEnvironmentVariable("PATH", $env:PATH, [System.EnvironmentVariableTarget]::Process)
            Write-Host "MinGW successfully added to PATH. Current PATH: $env:PATH"
        } catch {
            Write-Error "Failed to update PATH! Error: $_"
            exit 1
        }
        
        # Этап 5: Проверка наличия gcc и make
        Write-Host "Step 7: Verifying GCC and Make..."
        if (-Not (Get-Command "gcc" -ErrorAction SilentlyContinue)) {
            Write-Error "GCC is not available in PATH! Current PATH: $env:PATH"
            exit 1
        }
        Write-Host "GCC is available."
        if (-Not (Get-Command "make" -ErrorAction SilentlyContinue)) {
            Write-Error "Make is not available in PATH! Current PATH: $env:PATH"
            exit 1
        }
        Write-Host "Make is available."
        
        Write-Host "Step 8: MinGW setup completed successfully!"

  
    - name: Build Client
      shell: pwsh
      run: |
        cd client
        make -f Makefile.win
  
    - name: Upload Windows Client Binary
      uses: actions/upload-artifact@v4
      with:
        name: dnscat2-client-windows
        path: client/dnscat2-client.exe
